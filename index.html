<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Dokumentasi Tim Medis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .container {
            width: 95%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        header {
            background-color: #0066cc;
            color: white;
            padding: 15px 0;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        nav {
            background-color: #004d99;
            padding: 10px 0;
            overflow-x: auto;
            white-space: nowrap;
        }

        nav ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            text-align: center;
            display: flex;
            justify-content: center;
        }

        nav ul li {
            display: inline-block;
            margin: 0 10px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            display: block;
        }

        nav ul li a.active {
            border-bottom: 3px solid white;
        }

        .section {
            background-color: white;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        h2 {
            color: #0066cc;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 10px;
            font-size: 1.5rem;
            margin-top: 0;
        }

        h3 {
            color: #0066cc;
            font-size: 1.2rem;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        h3 i {
            margin-right: 8px;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            /* Ensures tables have a minimum width on mobile */
        }

        table,
        th,
        td {
            border: 1px solid #ddd;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            white-space: nowrap;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            /* Better for mobile touch */
        }

        /* Styling for number inputs to match other inputs */
        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
            appearance: textfield;
            /* Removes spinner on some browsers */
        }

        /* Remove spinner arrows from number inputs */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        textarea {
            height: 80px;
        }

        button {
            background-color: #0066cc;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            margin: 5px;
        }

        button:hover {
            background-color: #004d99;
        }

        .add-row-btn {
            margin: 10px 0;
            background-color: #28a745;
        }

        .delete-row-btn {
            background-color: #dc3545;
            padding: 4px 8px;
            font-size: 12px;
        }

        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .card-title {
            font-size: 16px;
            color: #666;
        }

        .card-value {
            font-size: 24px;
            font-weight: bold;
            color: #0066cc;
            margin: 10px 0;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .history-item:hover {
            background-color: #f9f9f9;
        }

        .history-item h3 {
            margin-top: 0;
            color: #333;
        }

        .history-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .view-btn,
        .download-btn {
            flex: 1;
            min-width: 120px;
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .edit-btn {
            background-color: #ffc107;
            color: #212529;
        }

        #dashboard,
        #history {
            display: none;
        }

        /* CSV Download instructions */
        .csv-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #0066cc;
        }

        /* Export/Import buttons */
        .export-import-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .import-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        #importDataBtn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h3 {
            margin: 0;
            color: #0066cc;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            margin: 0;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
        }

        /* Alert/Toast message */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }

        .toast.info {
            background-color: #0066cc;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            margin-right: 10px;
            font-size: 20px;
        }

        .toast-message {
            flex-grow: 1;
        }

        .toast-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }

        /* Mobile specific styles */
        @media screen and (max-width: 768px) {
            header h1 {
                font-size: 1.4rem;
            }

            .container {
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
            }

            .section {
                padding: 10px;
                min-width: 0;
            }

            button {
                width: 100%;
                margin: 5px 0;
            }

            .dashboard-cards {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .dashboard-card {
                padding: 10px;
            }

            .card-title {
                font-size: 14px;
            }

            .card-value {
                font-size: 20px;
            }

            .history-item {
                padding: 10px;
            }

            .history-actions {
                flex-direction: column;
            }

            .history-actions button {
                width: 100%;
                margin: 5px 0;
            }

            nav ul {
                display: flex;
                justify-content: space-between;
                width: 100%;
            }

            nav ul li {
                margin: 0;
                flex: 1;
            }

            nav ul li a {
                padding: 10px 5px;
                font-size: 14px;
            }

            .modal {
                width: 90%;
                margin: 0 5%;
            }

            /* Fix container padding */
            input[type="text"],
            input[type="date"],
            input[type="time"],
            input[type="number"],
            select,
            textarea {
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }

            /* Prevent table overflow */
            .table-container {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: auto;
                width: max-content;
            }

            /* Stack form info vertically */
            .form-info-table {
                width: 100%;
                box-sizing: border-box;
            }

            .form-info-table td {
                width: 100%;
                box-sizing: border-box;
                padding: 5px 0;
            }

            .form-info-table td:first-child {
                font-weight: bold;  
            }
        }

        /* Add styles for form layout table */
        .form-info-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .form-info-table td {
            padding: 8px;
            border: none;
        }

        .form-info-table td:first-child {
            width: 150px;
            /* Fixed width for labels */
            white-space: nowrap;
        }

        /* Add mobile-specific styles */
        @media screen and (max-width: 768px) {
            .form-info-table, 
            .form-info-table tbody,
            .form-info-table tr,
            .form-info-table td {
                display: block;
            }
            
            .form-info-table td:first-child {
                width: auto;
                padding-bottom: 2px;
            }
            
            .form-info-table td:last-child {
                margin-bottom: 12px;
            }

            /* Ensure colon is aligned */
            .form-info-table td:first-child::after {
                content: ":";
            }
        }

        .btn-primary {
            background-color: #0066cc;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }

        .btn-success {
            background-color: #28a745;
        }

        .btn-info {
            background-color: #17a2b8;
        }
    </style>
</head>

<body>
    <header>
        <h1>Sistem Dokumentasi Tim Medis</h1>
    </header>

    <nav>
        <ul>
            <li><a href="#" class="nav-link active" data-target="dashboard">Dashboard</a></li>
            <li><a href="#" class="nav-link" data-target="form">Form</a></li>
            <li><a href="#" class="nav-link" data-target="history">Riwayat</a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
            <div class="dashboard-cards">
                <div class="dashboard-card">
                    <div class="card-title">Total Dokumentasi</div>
                    <div class="card-value">0</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-title">Kasus Hari Ini</div>
                    <div class="card-value">0</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-title">Rujukan</div>
                    <div class="card-value">0</div>
                </div>
                <div class="dashboard-card">
                    <div class="card-title">Cabang Olahraga</div>
                    <div class="card-value">0</div>
                </div>
            </div>

            <h3><i class="fas fa-history"></i> Aktivitas Terbaru</h3>
            <div id="recent-activities">
                <div class="history-item">Belum ada aktivitas terbaru</div>
            </div>

            <div class="csv-info">
                <h3><i class="fas fa-file-csv"></i> Ekspor Data CSV</h3>
                <p>Ekspor semua data riwayat ke dalam format CSV.</p>
                <button id="downloadCSVAll">Download Semua Data (CSV)</button>
            </div>

            <div class="csv-info">
                <h3><i class="fas fa-file-export"></i> Ekspor/Impor Data</h3>
                <p>Ekspor data untuk berbagi atau backup. Impor data untuk memulihkan atau berbagi antar perangkat.</p>
                <div class="export-import-buttons">
                    <button id="exportDataBtn"><i class="fas fa-download"></i> Ekspor Data (.json)</button>
                    <div class="import-container">
                        <input type="file" id="fileInput" accept=".json" style="display: none;">
                        <button id="importTriggerBtn"><i class="fas fa-upload"></i> Pilih File</button>
                        <button id="importDataBtn" disabled>Proses Impor</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Section -->
        <div id="form" class="section">
            <h2 id="formTitle"><i class="fas fa-clipboard-list"></i> Form Dokumentasi Tim Medis</h2>
            <form id="medicalForm">
                <!-- Hidden fields for edit mode -->
                <input type="hidden" id="formMode" value="add">
                <input type="hidden" id="editItemId" value="">

                <table class="form-info-table">
                    <tr>
                        <td>Nama Petugas:</td>
                        <td><input type="text" id="petugas" name="petugas" required></td>
                    </tr>
                    <tr>
                        <td>Tanggal:</td>
                        <td><input type="date" id="tanggal" name="tanggal" required></td>
                    </tr>
                    <tr>
                        <td>Lokasi Kegiatan:</td>
                        <td><input type="text" id="lokasi" name="lokasi" required></td>
                    </tr>
                    <tr>
                        <td>Cabang Olahraga:</td>
                        <td><input type="text" id="cabor" name="cabor" required></td>
                    </tr>
                    <tr>
                        <td>Waktu:</td>
                        <td><input type="time" id="waktu" name="waktu" required></td>
                    </tr>
                </table>

                <h3><i class="fas fa-user-injured"></i> Data Kasus</h3>
                <div class="table-container">
                    <table id="dataKasusTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Waktu</th>
                                <th>Nama Pasien</th>
                                <th>Jenis Kelamin</th>
                                <th>Keluhan/Cedera</th>
                                <th>Penanganan</th>
                                <th>Hasil</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="time" name="kasus_waktu[]"></td>
                                <td><input type="text" name="kasus_nama[]"></td>
                                <td>
                                    <select name="kasus_jk[]">
                                        <option value="L">Laki-laki</option>
                                        <option value="P">Perempuan</option>
                                    </select>
                                </td>
                                <td><input type="text" name="kasus_keluhan[]"></td>
                                <td><input type="text" name="kasus_penanganan[]"></td>
                                <td><input type="text" name="kasus_hasil[]"></td>
                                <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="add-row-btn" id="addKasusRow">Tambah Baris</button>

                <h3><i class="fas fa-pills"></i> Penggunaan Obat & Alat Medis</h3>
                <div class="table-container">
                    <table id="penggunaanObatTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Item</th>
                                <th>Jumlah Awal</th>
                                <th>Jumlah Terpakai</th>
                                <th>Sisa</th>
                                <th>Keterangan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="text" name="obat_nama[]"></td>
                                <td><input type="number" name="obat_awal[]" class="obat-awal" min="0" step="0.01"></td>
                                <td><input type="number" name="obat_terpakai[]" class="obat-terpakai" min="0"
                                        step="0.01"></td>
                                <td><input type="number" name="obat_sisa[]" class="obat-sisa" readonly step="0.01"></td>
                                <td><input type="text" name="obat_keterangan[]"></td>
                                <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="add-row-btn" id="addObatRow">Tambah Baris</button>

                <h3><i class="fas fa-toolbox"></i> Catatan Perlengkapan dan Alat Medis</h3>
                <div class="table-container">
                    <table id="perlengkapanTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Perlengkapan</th>
                                <th>Kondisi Awal</th>
                                <th>Kondisi Akhir</th>
                                <th>Keterangan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="text" name="perlengkapan_nama[]"></td>
                                <td>
                                    <select name="perlengkapan_awal[]">
                                        <option value="Baik">Baik</option>
                                        <option value="Cukup Baik">Cukup Baik</option>
                                        <option value="Kurang Baik">Kurang Baik</option>
                                        <option value="Rusak">Rusak</option>
                                    </select>
                                </td>
                                <td>
                                    <select name="perlengkapan_akhir[]">
                                        <option value="Baik">Baik</option>
                                        <option value="Cukup Baik">Cukup Baik</option>
                                        <option value="Kurang Baik">Kurang Baik</option>
                                        <option value="Rusak">Rusak</option>
                                    </select>
                                </td>
                                <td><input type="text" name="perlengkapan_keterangan[]"></td>
                                <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="add-row-btn" id="addPerlengkapanRow">Tambah Baris</button>

                <h3><i class="fas fa-ambulance"></i> Rujukan Medis</h3>
                <div class="table-container">
                    <table id="rujukanTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Pasien</th>
                                <th>Alasan Rujukan</th>
                                <th>Fasilitas Kesehatan Tujuan</th>
                                <th>Waktu Rujukan</th>
                                <th>Keterangan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td><input type="text" name="rujukan_nama[]"></td>
                                <td><input type="text" name="rujukan_alasan[]"></td>
                                <td><input type="text" name="rujukan_tujuan[]"></td>
                                <td><input type="time" name="rujukan_waktu[]"></td>
                                <td><input type="text" name="rujukan_keterangan[]"></td>
                                <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <button type="button" class="add-row-btn" id="addRujukanRow">Tambah Baris</button>

                <h3><i class="fas fa-clipboard-check"></i> Evaluasi Kegiatan</h3>
                <div class="form-group">
                    <label for="kendala">Kendala yang Dihadapi:</label>
                    <textarea id="kendala" name="kendala"></textarea>
                </div>

                <div class="form-group">
                    <label for="solusi">Solusi yang Dilakukan:</label>
                    <textarea id="solusi" name="solusi"></textarea>
                </div>

                <div class="form-group">
                    <label for="rekomendasi">Rekomendasi untuk Kegiatan Selanjutnya:</label>
                    <textarea id="rekomendasi" name="rekomendasi"></textarea>
                </div>

                <div style="margin-top: 20px;">
                    <button type="submit" id="submitBtn" class="btn-success">Simpan Dokumentasi</button>
                    <button type="button" id="cancelBtn" class="btn-warning" style="display:none;">Batal</button>
                    <button type="button" id="generatePDF" class="btn-info">Unduh PDF</button>
                </div>
            </form>
        </div>

        <!-- History Section -->
        <div id="history" class="section">
            <h2><i class="fas fa-history"></i> Riwayat Dokumentasi</h2>
            <div id="history-list">
                <div class="history-item">Belum ada riwayat dokumentasi</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i> Konfirmasi</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Apakah Anda yakin ingin melakukan tindakan ini?</p>
            </div>
            <div class="modal-footer">
                <button id="cancelAction" class="btn">Batal</button>
                <button id="confirmAction" class="btn delete-btn">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Detail View Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Detail Dokumentasi</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- Detail content will be inserted here -->
            </div>
            <div class="modal-footer">
                <button class="close-modal btn">Tutup</button>
            </div>
        </div>
    </div>

    <!-- Import Options Modal -->
    <div class="modal-overlay" id="importOptionsModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-upload"></i> Opsi Impor</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Bagaimana Anda ingin menangani data yang akan diimpor?</p>
                <div class="form-group">
                    <label>
                        <input type="radio" name="importOption" value="replace" checked>
                        Ganti semua data yang ada dengan data baru
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="radio" name="importOption" value="merge">
                        Gabungkan dengan data yang sudah ada (tambahkan yang baru, perbarui yang sama)
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelImport" class="btn">Batal</button>
                <button id="confirmImport" class="btn">Impor</button>
            </div>
        </div>
    </div>

    <!-- Toast Messages Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Set automatic date and time and start real-time clock
            setCurrentDateTime();

            // Show dashboard by default
            document.getElementById('dashboard').style.display = 'block';

            // Navigation
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    // Stop real-time clock if leaving form section
                    if (document.querySelector('.nav-link.active').getAttribute('data-target') === 'form') {
                        stopRealtimeClock();
                    }

                    // Remove active class from all links
                    navLinks.forEach(link => link.classList.remove('active'));

                    // Add active class to clicked link
                    this.classList.add('active');

                    // Hide all sections
                    document.querySelectorAll('.section').forEach(section => {
                        section.style.display = 'none';
                    });

                    // Show the target section
                    const targetId = this.getAttribute('data-target');
                    document.getElementById(targetId).style.display = 'block';

                    // Start real-time clock if entering form section
                    if (targetId === 'form') {
                        startRealtimeClock();
                    }
                });
            });

            // Set current date and time
            function setCurrentDateTime() {
                const now = new Date();
                const dateInput = document.getElementById('tanggal');
                const timeInput = document.getElementById('waktu');

                // Format date as YYYY-MM-DD
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const formattedDate = `${year}-${month}-${day}`;

                // Format time as HH:MM
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const formattedTime = `${hours}:${minutes}`;

                dateInput.value = formattedDate;
                timeInput.value = formattedTime;

                // Start real-time clock update
                startRealtimeClock();
            }

            // Function to start real-time clock
            function startRealtimeClock() {
                // Clear any existing interval
                stopRealtimeClock();

                // Update time every second
                window.clockInterval = setInterval(function () {
                    const now = new Date();
                    const timeInput = document.getElementById('waktu');

                    // Format time as HH:MM
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    const formattedTime = `${hours}:${minutes}`;

                    timeInput.value = formattedTime;
                }, 1000);
            }

            // Function to stop real-time clock
            function stopRealtimeClock() {
                if (window.clockInterval) {
                    clearInterval(window.clockInterval);
                }
            }

            // Helper function for Indonesian date formatting
            function formatDateIndonesia(dateString) {
                const months = [
                    'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                    'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'
                ];
                const date = new Date(dateString);
                const day = date.getDate();
                const month = months[date.getMonth()];
                const year = date.getFullYear();
                return `${day} ${month} ${year}`;
            }

            // Function to format time
            function formatTime(dateString) {
                const date = new Date(dateString);
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            // Modal functionality
            const closeModalButtons = document.querySelectorAll('.close-modal');
            closeModalButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const modalOverlay = this.closest('.modal-overlay');
                    closeModal(modalOverlay);
                });
            });

            function openModal(modalId) {
                const modal = document.getElementById(modalId);
                modal.classList.add('active');

                // Close modal when clicking outside
                modal.addEventListener('click', function (e) {
                    if (e.target === this) {
                        closeModal(modal);
                    }
                });
            }

            function closeModal(modal) {
                modal.classList.remove('active');
            }

            // Toast message functionality
            function showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                if (type === 'error') icon = 'exclamation-circle';

                toast.innerHTML = `
                    <div class="toast-icon"><i class="fas fa-${icon}"></i></div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close">&times;</button>
                `;

                container.appendChild(toast);

                // Show the toast (with animation)
                setTimeout(() => {
                    toast.classList.add('show');
                }, 10);

                // Add event listener to close button
                toast.querySelector('.toast-close').addEventListener('click', function () {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        container.removeChild(toast);
                    }, 300);
                });

                // Auto close after 5 seconds
                setTimeout(() => {
                    if (container.contains(toast)) {
                        toast.classList.remove('show');
                        setTimeout(() => {
                            if (container.contains(toast)) {
                                container.removeChild(toast);
                            }
                        }, 300);
                    }
                }, 5000);
            }

            // Add row to tables
            document.getElementById('addKasusRow').addEventListener('click', function () {
                addTableRow('dataKasusTable', [
                    document.querySelectorAll('#dataKasusTable tbody tr').length + 1,
                    '<input type="time" name="kasus_waktu[]">',
                    '<input type="text" name="kasus_nama[]">',
                    '<select name="kasus_jk[]"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select>',
                    '<input type="text" name="kasus_keluhan[]">',
                    '<input type="text" name="kasus_penanganan[]">',
                    '<input type="text" name="kasus_hasil[]">',
                    '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                ]);
                showToast('Baris baru ditambahkan', 'success');
            });

            document.getElementById('addObatRow').addEventListener('click', function () {
                addTableRow('penggunaanObatTable', [
                    document.querySelectorAll('#penggunaanObatTable tbody tr').length + 1,
                    '<input type="text" name="obat_nama[]">',
                    '<input type="number" name="obat_awal[]" class="obat-awal" min="0" step="0.01">',
                    '<input type="number" name="obat_terpakai[]" class="obat-terpakai" min="0" step="0.01">',
                    '<input type="number" name="obat_sisa[]" class="obat-sisa" readonly step="0.01">',
                    '<input type="text" name="obat_keterangan[]">',
                    '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                ]);

                // Add event listeners for automatic sisa calculation
                addSisaCalculationEvents();
                showToast('Baris baru ditambahkan', 'success');
            });

            document.getElementById('addPerlengkapanRow').addEventListener('click', function () {
                addTableRow('perlengkapanTable', [
                    document.querySelectorAll('#perlengkapanTable tbody tr').length + 1,
                    '<input type="text" name="perlengkapan_nama[]">',
                    '<select name="perlengkapan_awal[]"><option value="Baik">Baik</option><option value="Cukup Baik">Cukup Baik</option><option value="Kurang Baik">Kurang Baik</option><option value="Rusak">Rusak</option></select>',
                    '<select name="perlengkapan_akhir[]"><option value="Baik">Baik</option><option value="Cukup Baik">Cukup Baik</option><option value="Kurang Baik">Kurang Baik</option><option value="Rusak">Rusak</option></select>',
                    '<input type="text" name="perlengkapan_keterangan[]">',
                    '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                ]);
                showToast('Baris baru ditambahkan', 'success');
            });

            document.getElementById('addRujukanRow').addEventListener('click', function () {
                addTableRow('rujukanTable', [
                    document.querySelectorAll('#rujukanTable tbody tr').length + 1,
                    '<input type="text" name="rujukan_nama[]">',
                    '<input type="text" name="rujukan_alasan[]">',
                    '<input type="text" name="rujukan_tujuan[]">',
                    '<input type="time" name="rujukan_waktu[]">',
                    '<input type="text" name="rujukan_keterangan[]">',
                    '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                ]);
                showToast('Baris baru ditambahkan', 'success');
            });

            // Function to add a new row to a table
            function addTableRow(tableId, cellContents) {
                const tbody = document.querySelector(`#${tableId} tbody`);
                const row = document.createElement('tr');

                cellContents.forEach(content => {
                    const cell = document.createElement('td');
                    cell.innerHTML = content;
                    row.appendChild(cell);
                });

                tbody.appendChild(row);

                // Add event listener to delete button
                const deleteBtn = row.querySelector('.delete-row-btn');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', function () {
                        confirmDeleteRow(this);
                    });
                }
            }

            // Function to confirm delete a table row
            function confirmDeleteRow(button) {
                const row = button.closest('tr');
                const tbody = row.parentNode;
                const rowIndex = Array.from(tbody.children).indexOf(row);

                document.getElementById('confirmMessage').textContent = 'Apakah Anda yakin ingin menghapus baris ini?';

                // Set up confirm modal buttons
                document.getElementById('confirmAction').onclick = function () {
                    tbody.removeChild(row);

                    // Renumber rows
                    const rows = tbody.querySelectorAll('tr');
                    rows.forEach((row, index) => {
                        row.cells[0].textContent = index + 1;
                    });

                    closeModal(document.getElementById('confirmModal'));
                    showToast('Baris berhasil dihapus', 'info');
                };

                document.getElementById('cancelAction').onclick = function () {
                    closeModal(document.getElementById('confirmModal'));
                };

                openModal('confirmModal');
            }

            // Add event listeners to existing delete buttons
            document.querySelectorAll('.delete-row-btn').forEach(button => {
                button.addEventListener('click', function () {
                    confirmDeleteRow(this);
                });
            });

            // Function to calculate "Sisa" automatically
            function addSisaCalculationEvents() {
                const rows = document.querySelectorAll('#penggunaanObatTable tbody tr');

                rows.forEach(row => {
                    const awalInput = row.querySelector('.obat-awal');
                    const terpakaiInput = row.querySelector('.obat-terpakai');
                    const sisaInput = row.querySelector('.obat-sisa');

                    if (awalInput && terpakaiInput && sisaInput) {
                        const calculateSisa = function () {
                            const awal = parseFloat(awalInput.value) || 0;
                            const terpakai = parseFloat(terpakaiInput.value) || 0;
                            sisaInput.value = (awal - terpakai).toFixed(2);
                        };

                        awalInput.addEventListener('input', calculateSisa);
                        terpakaiInput.addEventListener('input', calculateSisa);

                        // Initial calculation
                        calculateSisa();
                    }
                });
            }

            // Initialize sisa calculation for existing rows
            addSisaCalculationEvents();

            // Function to convert all data to CSV
            function convertAllDataToCSV(dataArray) {
                // Create CSV header for main data
                let csvContent = "id,tanggal_input,petugas,tanggal,lokasi,cabor,waktu,kendala,solusi,rekomendasi\n";

                // Add data rows
                dataArray.forEach(data => {
                    csvContent += `${data.id},${data.date.split('T')[0]},${escapeCSV(data.petugas)},${data.tanggal},${escapeCSV(data.lokasi)},${escapeCSV(data.cabor)},${data.waktu},${escapeCSV(data.kendala || "")},${escapeCSV(data.solusi || "")},${escapeCSV(data.rekomendasi || "")}\n`;
                });

                // Add separator
                csvContent += "\n\n";

                // Add Kasus Data
                csvContent += "id,Waktu,Nama Pasien,Jenis Kelamin,Keluhan/Cedera,Penanganan,Hasil\n";

                dataArray.forEach(data => {
                    if (Array.isArray(data.kasus_nama)) {
                        for (let i = 0; i < data.kasus_nama.length; i++) {
                            if (data.kasus_nama[i] && data.kasus_nama[i].trim() !== '') {
                                csvContent += `${data.id},${data.kasus_waktu ? data.kasus_waktu[i] || '' : ''},${escapeCSV(data.kasus_nama[i] || '')},${data.kasus_jk ? data.kasus_jk[i] || '' : ''},${escapeCSV(data.kasus_keluhan ? data.kasus_keluhan[i] || '' : '')},${escapeCSV(data.kasus_penanganan ? data.kasus_penanganan[i] || '' : '')},${escapeCSV(data.kasus_hasil ? data.kasus_hasil[i] || '' : '')}\n`;
                            }
                        }
                    }
                });

                // Add separator
                csvContent += "\n\n";

                // Add Obat Data
                csvContent += "id,Nama Item,Jumlah Awal,Jumlah Terpakai,Sisa,Keterangan\n";

                dataArray.forEach(data => {
                    if (Array.isArray(data.obat_nama)) {
                        for (let i = 0; i < data.obat_nama.length; i++) {
                            if (data.obat_nama[i] && data.obat_nama[i].trim() !== '') {
                                csvContent += `${data.id},${escapeCSV(data.obat_nama[i] || '')},${data.obat_awal ? data.obat_awal[i] || '' : ''},${data.obat_terpakai ? data.obat_terpakai[i] || '' : ''},${data.obat_sisa ? data.obat_sisa[i] || '' : ''},${escapeCSV(data.obat_keterangan ? data.obat_keterangan[i] || '' : '')}\n`;
                            }
                        }
                    }
                });

                // Add separator
                csvContent += "\n\n";

                // Add Perlengkapan Data
                csvContent += "id,Nama Perlengkapan,Kondisi Awal,Kondisi Akhir,Keterangan\n";

                dataArray.forEach(data => {
                    if (Array.isArray(data.perlengkapan_nama)) {
                        for (let i = 0; i < data.perlengkapan_nama.length; i++) {
                            if (data.perlengkapan_nama[i] && data.perlengkapan_nama[i].trim() !== '') {
                                csvContent += `${data.id},${escapeCSV(data.perlengkapan_nama[i] || '')},${escapeCSV(data.perlengkapan_awal ? data.perlengkapan_awal[i] || '' : '')},${escapeCSV(data.perlengkapan_akhir ? data.perlengkapan_akhir[i] || '' : '')},${escapeCSV(data.perlengkapan_keterangan ? data.perlengkapan_keterangan[i] || '' : '')}\n`;
                            }
                        }
                    }
                });

                // Add separator
                csvContent += "\n\n";

                // Add Rujukan Data
                csvContent += "id,Nama Pasien,Alasan Rujukan,Fasilitas Kesehatan Tujuan,Waktu Rujukan,Keterangan\n";

                dataArray.forEach(data => {
                    if (Array.isArray(data.rujukan_nama)) {
                        for (let i = 0; i < data.rujukan_nama.length; i++) {
                            if (data.rujukan_nama[i] && data.rujukan_nama[i].trim() !== '') {
                                csvContent += `${data.id},${escapeCSV(data.rujukan_nama[i] || '')},${escapeCSV(data.rujukan_alasan ? data.rujukan_alasan[i] || '' : '')},${escapeCSV(data.rujukan_tujuan ? data.rujukan_tujuan[i] || '' : '')},${data.rujukan_waktu ? data.rujukan_waktu[i] || '' : ''},${escapeCSV(data.rujukan_keterangan ? data.rujukan_keterangan[i] || '' : '')}\n`;
                            }
                        }
                    }
                });

                return csvContent;
            }

            // Function to escape CSV values
            function escapeCSV(value) {
                if (value === null || value === undefined) return "";
                return `"${String(value).replace(/"/g, '""')}"`;
            }

            // Function to download CSV
            function downloadCSV(csvContent, filename) {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');

                // Create download link
                if (navigator.msSaveBlob) { // IE 10+
                    navigator.msSaveBlob(blob, filename);
                } else {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }

            // Download all data as CSV
            document.getElementById('downloadCSVAll').addEventListener('click', function () {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                if (savedData.length === 0) {
                    showToast('Belum ada data yang tersimpan', 'error');
                    return;
                }

                const csvContent = convertAllDataToCSV(savedData);
                downloadCSV(csvContent, 'riwayat.csv');
                showToast('Data CSV berhasil diunduh', 'success');
            });

            // Export data to JSON file
            document.getElementById('exportDataBtn').addEventListener('click', function () {
                exportData();
            });

            function exportData() {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];

                if (savedData.length === 0) {
                    showToast('Belum ada data yang tersimpan', 'error');
                    return;
                }

                // Convert data to JSON string
                const jsonData = JSON.stringify(savedData, null, 2);

                // Create a blob and download link
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'data_tim_medis.json';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast('Data berhasil diekspor', 'success');
            }

            // Import trigger and file input
            document.getElementById('importTriggerBtn').addEventListener('click', function () {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', function () {
                const importBtn = document.getElementById('importDataBtn');
                importBtn.disabled = !this.files || this.files.length === 0;

                if (!importBtn.disabled) {
                    showToast('File dipilih. Klik "Proses Impor" untuk melanjutkan.', 'info');
                }
            });

            // Import data button
            document.getElementById('importDataBtn').addEventListener('click', function () {
                openModal('importOptionsModal');
            });

            // Import option handlers
            document.getElementById('cancelImport').addEventListener('click', function () {
                closeModal(document.getElementById('importOptionsModal'));
                document.getElementById('fileInput').value = '';
                document.getElementById('importDataBtn').disabled = true;
            });

            document.getElementById('confirmImport').addEventListener('click', function () {
                const option = document.querySelector('input[name="importOption"]:checked').value;
                processImport(option);
                closeModal(document.getElementById('importOptionsModal'));
            });

            // Function to process the import
            function processImport(option) {
                const fileInput = document.getElementById('fileInput');

                if (!fileInput.files || fileInput.files.length === 0) {
                    showToast('Silakan pilih file terlebih dahulu', 'error');
                    return;
                }

                const file = fileInput.files[0];
                const reader = new FileReader();

                reader.onload = function (e) {
                    try {
                        const importedData = JSON.parse(e.target.result);

                        // Validate imported data
                        if (!Array.isArray(importedData)) {
                            throw new Error('Format data tidak valid');
                        }

                        if (option === 'replace') {
                            // Replace all existing data
                            localStorage.setItem('medicalDocuments', JSON.stringify(importedData));
                        } else if (option === 'merge') {
                            // Merge with existing data
                            const existingData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                            const mergedData = [...existingData];

                            // Merge based on unique IDs
                            importedData.forEach(item => {
                                const index = mergedData.findIndex(doc => doc.id === item.id);
                                if (index !== -1) {
                                    mergedData[index] = item; // Replace existing
                                } else {
                                    mergedData.push(item); // Add new
                                }
                            });

                            localStorage.setItem('medicalDocuments', JSON.stringify(mergedData));
                        }

                        showToast('Data berhasil diimpor', 'success');
                        updateDashboard();
                        updateHistory();

                        // Reset file input
                        fileInput.value = '';
                        document.getElementById('importDataBtn').disabled = true;
                    } catch (error) {
                        showToast(`Gagal mengimpor data: ${error.message}`, 'error');
                    }
                };

                reader.readAsText(file);
            }

            // Save form data
            document.getElementById('medicalForm').addEventListener('submit', function (e) {
                e.preventDefault();

                // Validate form
                if (!validateForm()) {
                    showToast('Mohon lengkapi data dengan benar', 'error');
                    return;
                }

                // Get basic form data
                const formDataObj = {
                    petugas: document.getElementById('petugas').value,
                    tanggal: document.getElementById('tanggal').value,
                    lokasi: document.getElementById('lokasi').value,
                    cabor: document.getElementById('cabor').value,
                    waktu: document.getElementById('waktu').value,
                    kendala: document.getElementById('kendala').value,
                    solusi: document.getElementById('solusi').value,
                    rekomendasi: document.getElementById('rekomendasi').value,
                    action: document.getElementById('formMode').value === 'edit' ? 'edit' : 'add',
                    actionText: document.getElementById('formMode').value === 'edit' ? 'mengedit' : 'mendokumentasikan'
                };

                // Collect table data
                // Kasus data
                formDataObj.kasus_waktu = [];
                formDataObj.kasus_nama = [];
                formDataObj.kasus_jk = [];
                formDataObj.kasus_keluhan = [];
                formDataObj.kasus_penanganan = [];
                formDataObj.kasus_hasil = [];

                const kasusRows = document.querySelectorAll('#dataKasusTable tbody tr');
                kasusRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    formDataObj.kasus_waktu.push(cells[1].querySelector('input').value);
                    formDataObj.kasus_nama.push(cells[2].querySelector('input').value);
                    formDataObj.kasus_jk.push(cells[3].querySelector('select').value);
                    formDataObj.kasus_keluhan.push(cells[4].querySelector('input').value);
                    formDataObj.kasus_penanganan.push(cells[5].querySelector('input').value);
                    formDataObj.kasus_hasil.push(cells[6].querySelector('input').value);
                });

                // Obat data
                formDataObj.obat_nama = [];
                formDataObj.obat_awal = [];
                formDataObj.obat_terpakai = [];
                formDataObj.obat_sisa = [];
                formDataObj.obat_keterangan = [];

                const obatRows = document.querySelectorAll('#penggunaanObatTable tbody tr');
                obatRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    formDataObj.obat_nama.push(cells[1].querySelector('input').value);
                    formDataObj.obat_awal.push(cells[2].querySelector('input').value);
                    formDataObj.obat_terpakai.push(cells[3].querySelector('input').value);
                    formDataObj.obat_sisa.push(cells[4].querySelector('input').value);
                    formDataObj.obat_keterangan.push(cells[5].querySelector('input').value);
                });

                // Perlengkapan data
                formDataObj.perlengkapan_nama = [];
                formDataObj.perlengkapan_awal = [];
                formDataObj.perlengkapan_akhir = [];
                formDataObj.perlengkapan_keterangan = [];

                const perlengkapanRows = document.querySelectorAll('#perlengkapanTable tbody tr');
                perlengkapanRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    formDataObj.perlengkapan_nama.push(cells[1].querySelector('input').value);
                    formDataObj.perlengkapan_awal.push(cells[2].querySelector('select').value);
                    formDataObj.perlengkapan_akhir.push(cells[3].querySelector('select').value);
                    formDataObj.perlengkapan_keterangan.push(cells[4].querySelector('input').value);
                });

                // Rujukan data
                formDataObj.rujukan_nama = [];
                formDataObj.rujukan_alasan = [];
                formDataObj.rujukan_tujuan = [];
                formDataObj.rujukan_waktu = [];
                formDataObj.rujukan_keterangan = [];

                const rujukanRows = document.querySelectorAll('#rujukanTable tbody tr');
                rujukanRows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    formDataObj.rujukan_nama.push(cells[1].querySelector('input').value);
                    formDataObj.rujukan_alasan.push(cells[2].querySelector('input').value);
                    formDataObj.rujukan_tujuan.push(cells[3].querySelector('input').value);
                    formDataObj.rujukan_waktu.push(cells[4].querySelector('input').value);
                    formDataObj.rujukan_keterangan.push(cells[5].querySelector('input').value);
                });

                // Get saved data
                let savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];

                // Check if we're in edit mode
                const formMode = document.getElementById('formMode').value;
                const editItemId = parseInt(document.getElementById('editItemId').value);

                if (formMode === 'edit' && editItemId) {
                    // Update existing record
                    const index = savedData.findIndex(item => item.id === editItemId);

                    if (index !== -1) {
                        // Preserve original id and creation date
                        formDataObj.id = editItemId;
                        formDataObj.date = savedData[index].date;
                        formDataObj.updated = new Date().toISOString(); // Add update timestamp

                        // Replace the item at the index
                        savedData[index] = formDataObj;

                        showToast('Dokumentasi berhasil diperbarui!', 'success');
                    } else {
                        showToast('Data yang diedit tidak ditemukan', 'error');
                        return;
                    }
                } else {
                    // Add new record
                    formDataObj.id = Date.now(); // Use timestamp as ID
                    formDataObj.date = new Date().toISOString();
                    savedData.push(formDataObj);

                    showToast('Dokumentasi berhasil disimpan!', 'success');
                }

                // Save updated data
                localStorage.setItem('medicalDocuments', JSON.stringify(savedData));

                // Update recent activities
                let recentActs = JSON.parse(localStorage.getItem('recentActivities') || '[]');
                recentActs.unshift(formDataObj);
                recentActs = recentActs.slice(0, 5); // Keep only last 5
                localStorage.setItem('recentActivities', JSON.stringify(recentActs));

                // Update dashboard and history
                updateDashboard();
                updateHistory();

                // Reset form mode
                document.getElementById('formMode').value = 'add';
                document.getElementById('editItemId').value = '';
                document.getElementById('formTitle').textContent = 'Form Dokumentasi Tim Medis';
                document.getElementById('submitBtn').textContent = 'Simpan Dokumentasi';
                document.getElementById('cancelBtn').style.display = 'none';

                // Reset form and set new date/time
                this.reset();
                setCurrentDateTime();

                // Add default rows back
                resetTableRows();

                // Go to dashboard
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.getAttribute('data-target') === 'dashboard') {
                        link.click();
                    }
                });
            });

            // Fix save changes button functionality
            document.getElementById('submitBtn').addEventListener('click', function(e) {
                const formMode = document.getElementById('formMode').value;
                if (formMode === 'edit') {
                    if (validateForm()) {
                        document.getElementById('medicalForm').dispatchEvent(new Event('submit'));
                    } else {
                        showToast('Mohon lengkapi data dengan benar', 'error');
                    }
                }
            });

            // Remove old cancel button event listener and replace with new one
            document.getElementById('cancelBtn').addEventListener('click', function() {
                document.getElementById('confirmMessage').textContent = 'Batalkan perubahan? Semua perubahan akan hilang.';
                document.getElementById('confirmAction').textContent = 'Ya, Batalkan';
                document.getElementById('confirmAction').className = 'btn btn-warning';
                
                // Set up confirm modal buttons
                document.getElementById('confirmAction').onclick = function() {
                    // Reset form mode
                    document.getElementById('formMode').value = 'add';
                    document.getElementById('editItemId').value = '';
                    document.getElementById('formTitle').textContent = 'Form Dokumentasi Tim Medis';
                    document.getElementById('submitBtn').textContent = 'Simpan Dokumentasi';
                    document.getElementById('cancelBtn').style.display = 'none';

                    // Reset form and tables
                    document.getElementById('medicalForm').reset();
                    setCurrentDateTime();
                    resetTableRows();

                    closeModal(document.getElementById('confirmModal'));
                    showToast('Pengeditan dibatalkan', 'info');
                };

                document.getElementById('cancelAction').onclick = function() {
                    closeModal(document.getElementById('confirmModal'));
                };

                openModal('confirmModal');
            });

            // Function to enable edit mode for an existing record
            function editItem(id) {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                const item = savedData.find(doc => doc.id === id);

                if (item) {
                    // Switch to form view
                    document.querySelectorAll('.nav-link').forEach(link => {
                        if (link.getAttribute('data-target') === 'form') {
                            link.click();
                        }
                    });
                    // Set form in edit mode
                    document.getElementById('formMode').value = 'edit';
                    document.getElementById('editItemId').value = id;
                    document.getElementById('formTitle').textContent = 'Edit Dokumentasi Tim Medis';
                    document.getElementById('submitBtn').textContent = 'Simpan Perubahan';
                    document.getElementById('cancelBtn').style.display = 'inline-block';

                    // Fill form with data - notice we're not setting the time, it will be current real-time
                    document.getElementById('petugas').value = item.petugas;
                    document.getElementById('tanggal').value = item.tanggal;
                    document.getElementById('lokasi').value = item.lokasi;
                    document.getElementById('cabor').value = item.cabor;
                    // We don't set time here since we want it to be real-time: document.getElementById('waktu').value = item.waktu;
                    document.getElementById('kendala').value = item.kendala || '';
                    document.getElementById('solusi').value = item.solusi || '';
                    document.getElementById('rekomendasi').value = item.rekomendasi || '';

                    // Clear all tables
                    document.querySelector('#dataKasusTable tbody').innerHTML = '';
                    document.querySelector('#penggunaanObatTable tbody').innerHTML = '';
                    document.querySelector('#perlengkapanTable tbody').innerHTML = '';
                    document.querySelector('#rujukanTable tbody').innerHTML = '';

                    // Fill Kasus table
                    if (Array.isArray(item.kasus_nama)) {
                        for (let i = 0; i < item.kasus_nama.length; i++) {
                            if (item.kasus_nama[i]) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${i + 1}</td>
                                    <td><input type="time" name="kasus_waktu[]" value="${item.kasus_waktu[i] || ''}"></td>
                                    <td><input type="text" name="kasus_nama[]" value="${item.kasus_nama[i] || ''}"></td>
                                    <td>
                                        <select name="kasus_jk[]">
                                            <option value="L" ${(item.kasus_jk[i] === 'L') ? 'selected' : ''}>Laki-laki</option>
                                            <option value="P" ${(item.kasus_jk[i] === 'P') ? 'selected' : ''}>Perempuan</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="kasus_keluhan[]" value="${item.kasus_keluhan[i] || ''}"></td>
                                    <td><input type="text" name="kasus_penanganan[]" value="${item.kasus_penanganan[i] || ''}"></td>
                                    <td><input type="text" name="kasus_hasil[]" value="${item.kasus_hasil[i] || ''}"></td>
                                    <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                                `;
                                document.querySelector('#dataKasusTable tbody').appendChild(row);
                            }
                        }
                    }

                    // If no kasus data, add empty row
                    if (document.querySelector('#dataKasusTable tbody').children.length === 0) {
                        addTableRow('dataKasusTable', [
                            1,
                            '<input type="time" name="kasus_waktu[]">',
                            '<input type="text" name="kasus_nama[]">',
                            '<select name="kasus_jk[]"><option value="L">Laki-laki</option><option value="P">Perempuan</option></select>',
                            '<input type="text" name="kasus_keluhan[]">',
                            '<input type="text" name="kasus_penanganan[]">',
                            '<input type="text" name="kasus_hasil[]">',
                            '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                        ]);
                    }

                    // Fill Obat table
                    if (Array.isArray(item.obat_nama)) {
                        for (let i = 0; i < item.obat_nama.length; i++) {
                            if (item.obat_nama[i]) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${i + 1}</td>
                                    <td><input type="text" name="obat_nama[]" value="${item.obat_nama[i] || ''}"></td>
                                    <td><input type="number" name="obat_awal[]" class="obat-awal" min="0" step="0.01" value="${item.obat_awal[i] || '0'}"></td>
                                    <td><input type="number" name="obat_terpakai[]" class="obat-terpakai" min="0" step="0.01" value="${item.obat_terpakai[i] || '0'}"></td>
                                    <td><input type="number" name="obat_sisa[]" class="obat-sisa" readonly step="0.01" value="${item.obat_sisa[i] || '0'}"></td>
                                    <td><input type="text" name="obat_keterangan[]" value="${item.obat_keterangan ? item.obat_keterangan[i] || '' : ''}"></td>
                                    <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                                `;
                                document.querySelector('#penggunaanObatTable tbody').appendChild(row);
                            }
                        }
                    }

                    // If no obat data, add empty row
                    if (document.querySelector('#penggunaanObatTable tbody').children.length === 0) {
                        addTableRow('penggunaanObatTable', [
                            1,
                            '<input type="text" name="obat_nama[]">',
                            '<input type="number" name="obat_awal[]" class="obat-awal" min="0" step="0.01">',
                            '<input type="number" name="obat_terpakai[]" class="obat-terpakai" min="0" step="0.01">',
                            '<input type="number" name="obat_sisa[]" class="obat-sisa" readonly step="0.01">',
                            '<input type="text" name="obat_keterangan[]">',
                            '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                        ]);
                    }

                    // Fill Perlengkapan table
                    if (Array.isArray(item.perlengkapan_nama)) {
                        for (let i = 0; i < item.perlengkapan_nama.length; i++) {
                            if (item.perlengkapan_nama[i]) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${i + 1}</td>
                                    <td><input type="text" name="perlengkapan_nama[]" value="${item.perlengkapan_nama[i] || ''}"></td>
                                    <td>
                                        <select name="perlengkapan_awal[]">
                                            <option value="Baik" ${(item.perlengkapan_awal[i] === 'Baik') ? 'selected' : ''}>Baik</option>
                                            <option value="Cukup Baik" ${(item.perlengkapan_awal[i] === 'Cukup Baik') ? 'selected' : ''}>Cukup Baik</option>
                                            <option value="Kurang Baik" ${(item.perlengkapan_awal[i] === 'Kurang Baik') ? 'selected' : ''}>Kurang Baik</option>
                                            <option value="Rusak" ${(item.perlengkapan_awal[i] === 'Rusak') ? 'selected' : ''}>Rusak</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="perlengkapan_akhir[]">
                                            <option value="Baik" ${(item.perlengkapan_akhir[i] === 'Baik') ? 'selected' : ''}>Baik</option>
                                            <option value="Cukup Baik" ${(item.perlengkapan_akhir[i] === 'Cukup Baik') ? 'selected' : ''}>Cukup Baik</option>
                                            <option value="Kurang Baik" ${(item.perlengkapan_akhir[i] === 'Kurang Baik') ? 'selected' : ''}>Kurang Baik</option>
                                            <option value="Rusak" ${(item.perlengkapan_akhir[i] === 'Rusak') ? 'selected' : ''}>Rusak</option>
                                        </select>
                                    </td>
                                    <td><input type="text" name="perlengkapan_keterangan[]" value="${item.perlengkapan_keterangan[i] || ''}"></td>
                                    <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                                `;
                                document.querySelector('#perlengkapanTable tbody').appendChild(row);
                            }
                        }
                    }

                    // If no perlengkapan data, add empty row
                    if (document.querySelector('#perlengkapanTable tbody').children.length === 0) {
                        addTableRow('perlengkapanTable', [
                            1,
                            '<input type="text" name="perlengkapan_nama[]">',
                            '<select name="perlengkapan_awal[]"><option value="Baik">Baik</option><option value="Cukup Baik">Cukup Baik</option><option value="Kurang Baik">Kurang Baik</option><option value="Rusak">Rusak</option></select>',
                            '<select name="perlengkapan_akhir[]"><option value="Baik">Baik</option><option value="Cukup Baik">Cukup Baik</option><option value="Kurang Baik">Kurang Baik</option><option value="Rusak">Rusak</option></select>',
                            '<input type="text" name="perlengkapan_keterangan[]">',
                            '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                        ]);
                    }

                    // Fill Rujukan table
                    if (Array.isArray(item.rujukan_nama)) {
                        for (let i = 0; i < item.rujukan_nama.length; i++) {
                            if (item.rujukan_nama[i]) {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${i + 1}</td>
                                    <td><input type="text" name="rujukan_nama[]" value="${item.rujukan_nama[i] || ''}"></td>
                                    <td><input type="text" name="rujukan_alasan[]" value="${item.rujukan_alasan[i] || ''}"></td>
                                    <td><input type="text" name="rujukan_tujuan[]" value="${item.rujukan_tujuan[i] || ''}"></td>
                                    <td><input type="time" name="rujukan_waktu[]" value="${item.rujukan_waktu[i] || ''}"></td>
                                    <td><input type="text" name="rujukan_keterangan[]" value="${item.rujukan_keterangan[i] || ''}"></td>
                                    <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                                `;
                                document.querySelector('#rujukanTable tbody').appendChild(row);
                            }
                        }
                    }

                    // If no rujukan data, add empty row
                    if (document.querySelector('#rujukanTable tbody').children.length === 0) {
                        addTableRow('rujukanTable', [
                            1,
                            '<input type="text" name="rujukan_nama[]">',
                            '<input type="text" name="rujukan_alasan[]">',
                            '<input type="text" name="rujukan_tujuan[]">',
                            '<input type="time" name="rujukan_waktu[]">',
                            '<input type="text" name="rujukan_keterangan[]">',
                            '<button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button>'
                        ]);
                    }

                    // Re-attach event listeners
                    document.querySelectorAll('.delete-row-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            confirmDeleteRow(this);
                        });
                    });

                    // Re-initialize sisa calculation
                    addSisaCalculationEvents();

                    // Start real-time clock if not already running
                    startRealtimeClock();

                    showToast(`Mengedit dokumentasi: ${item.cabor} - ${item.lokasi}`, 'info');
                } else {
                    showToast('Data tidak ditemukan', 'error');
                }
            }

            // Basic form validation
            function validateForm() {
                const petugas = document.getElementById('petugas').value;
                const lokasi = document.getElementById('lokasi').value;
                const cabor = document.getElementById('cabor').value;

                return petugas.trim() !== '' && lokasi.trim() !== '' && cabor.trim() !== '';
            }

            // Reset table to initial state with one empty row each
            function resetTableRows() {
                // Reset Kasus table
                document.querySelector('#dataKasusTable tbody').innerHTML = `
                    <tr>
                        <td>1</td>
                        <td><input type="time" name="kasus_waktu[]"></td>
                        <td><input type="text" name="kasus_nama[]"></td>
                        <td>
                            <select name="kasus_jk[]">
                                <option value="L">Laki-laki</option>
                                <option value="P">Perempuan</option>
                            </select>
                        </td>
                        <td><input type="text" name="kasus_keluhan[]"></td>
                        <td><input type="text" name="kasus_penanganan[]"></td>
                        <td><input type="text" name="kasus_hasil[]"></td>
                        <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;

                // Reset Obat table
                document.querySelector('#penggunaanObatTable tbody').innerHTML = `
                    <tr>
                        <td>1</td>
                        <td><input type="text" name="obat_nama[]"></td>
                        <td><input type="number" name="obat_awal[]" class="obat-awal" min="0" step="0.01"></td>
                        <td><input type="number" name="obat_terpakai[]" class="obat-terpakai" min="0" step="0.01"></td>
                        <td><input type="number" name="obat_sisa[]" class="obat-sisa" readonly step="0.01"></td>
                        <td><input type="text" name="obat_keterangan[]"></td>
                        <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;

                // Reset Perlengkapan table
                document.querySelector('#perlengkapanTable tbody').innerHTML = `
                    <tr>
                        <td>1</td>
                        <td><input type="text" name="perlengkapan_nama[]"></td>
                        <td>
                            <select name="perlengkapan_awal[]">
                                <option value="Baik">Baik</option>
                                <option value="Cukup Baik">Cukup Baik</option>
                                <option value="Kurang Baik">Kurang Baik</option>
                                <option value="Rusak">Rusak</option>
                            </select>
                        </td>
                        <td>
                            <select name="perlengkapan_akhir[]">
                                <option value="Baik">Baik</option>
                                <option value="Cukup Baik">Cukup Baik</option>
                                <option value="Kurang Baik">Kurang Baik</option>
                                <option value="Rusak">Rusak</option>
                            </select>
                        </td>
                        <td><input type="text" name="perlengkapan_keterangan[]"></td>
                        <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;

                // Reset Rujukan table
                document.querySelector('#rujukanTable tbody').innerHTML = `
                    <tr>
                        <td>1</td>
                        <td><input type="text" name="rujukan_nama[]"></td>
                        <td><input type="text" name="rujukan_alasan[]"></td>
                        <td><input type="text" name="rujukan_tujuan[]"></td>
                        <td><input type="time" name="rujukan_waktu[]"></td>
                        <td><input type="text" name="rujukan_keterangan[]"></td>
                        <td><button type="button" class="delete-row-btn"><i class="fas fa-trash"></i></button></td>
                    </tr>
                `;

                // Re-attach event listeners
                document.querySelectorAll('.delete-row-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        confirmDeleteRow(this);
                    });
                });

                // Re-initialize sisa calculation
                addSisaCalculationEvents();
            }

            // Generate PDF
            document.getElementById('generatePDF').addEventListener('click', function () {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Set font to Times New Roman
                doc.setFont("times", "normal");
                doc.setFontSize(12);

                // Add header
                doc.setFontSize(16);
                doc.text("DOKUMENTASI & ADMINISTRASI TIM MEDIC", 105, 20, { align: 'center' });
                doc.setFontSize(12);

                // Add form data
                const petugas = document.getElementById('petugas').value;
                const tanggal = document.getElementById('tanggal').value;
                const lokasi = document.getElementById('lokasi').value;
                const cabor = document.getElementById('cabor').value;
                const waktu = document.getElementById('waktu').value;

                const spacing = 56; // Reduced from 150 to 100 for tighter layout
                const colonPos = 54; // Position for colons

                // Helper function to draw aligned text
                function drawFormField(label, value, yPos) {
                    doc.text(label, 20, yPos);
                    doc.text(":", colonPos, yPos);
                    doc.text(value, spacing, yPos);
                }

                // Draw form fields with aligned colons
                drawFormField("Nama Petugas", petugas, 40);
                drawFormField("Tanggal", tanggal, 48);
                drawFormField("Lokasi Kegiatan", lokasi, 56);
                drawFormField("Cabang Olahraga", cabor, 64);
                drawFormField("Waktu", waktu, 72);

                // Data Kasus table
                doc.text("DATA KASUS", 20, 85);

                const kasusData = [];
                const kasusRows = document.querySelectorAll('#dataKasusTable tbody tr');
                kasusRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    rowData.push(cells[0].textContent);
                    rowData.push(cells[1].querySelector('input').value);
                    rowData.push(cells[2].querySelector('input').value);
                    rowData.push(cells[3].querySelector('select').value);
                    rowData.push(cells[4].querySelector('input').value);
                    rowData.push(cells[5].querySelector('input').value);
                    rowData.push(cells[6].querySelector('input').value);
                    kasusData.push(rowData);
                });

                doc.autoTable({
                    startY: 90,
                    head: [['No.', 'Waktu', 'Nama Pasien', 'Jenis Kelamin', 'Keluhan/Cedera', 'Penanganan', 'Hasil']],
                    body: kasusData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Penggunaan Obat table
                let currentY = doc.lastAutoTable.finalY + 10;
                doc.text("PENGGUNAAN OBAT & ALAT MEDIS", 20, currentY);

                const obatData = [];
                const obatRows = document.querySelectorAll('#penggunaanObatTable tbody tr');
                obatRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    rowData.push(cells[0].textContent);
                    rowData.push(cells[1].querySelector('input').value);
                    rowData.push(cells[2].querySelector('input').value);
                    rowData.push(cells[3].querySelector('input').value);
                    rowData.push(cells[4].querySelector('input').value);
                    rowData.push(cells[5].querySelector('input').value); // Keterangan
                    obatData.push(rowData);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    head: [['No.', 'Nama Item', 'Jumlah Awal', 'Jumlah Terpakai', 'Sisa', 'Keterangan']],
                    body: obatData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Perlengkapan table
                currentY = doc.lastAutoTable.finalY + 10;
                doc.text("CATATAN PERLENGKAPAN DAN ALAT MEDIS", 20, currentY);

                const perlengkapanData = [];
                const perlengkapanRows = document.querySelectorAll('#perlengkapanTable tbody tr');
                perlengkapanRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    rowData.push(cells[0].textContent);
                    rowData.push(cells[1].querySelector('input').value);
                    rowData.push(cells[2].querySelector('select').value);
                    rowData.push(cells[3].querySelector('select').value);
                    rowData.push(cells[4].querySelector('input').value);
                    perlengkapanData.push(rowData);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    head: [['No.', 'Nama Perlengkapan', 'Kondisi Awal', 'Kondisi Akhir', 'Keterangan']],
                    body: perlengkapanData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Rujukan Medis table
                currentY = doc.lastAutoTable.finalY + 10;
                doc.text("RUJUKAN MEDIS", 20, currentY);

                const rujukanData = [];
                const rujukanRows = document.querySelectorAll('#rujukanTable tbody tr');
                rujukanRows.forEach((row, index) => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    rowData.push(cells[0].textContent);
                    rowData.push(cells[1].querySelector('input').value);
                    rowData.push(cells[2].querySelector('input').value);
                    rowData.push(cells[3].querySelector('input').value);
                    rowData.push(cells[4].querySelector('input').value);
                    rowData.push(cells[5].querySelector('input').value);
                    rujukanData.push(rowData);
                });

                doc.autoTable({
                    startY: currentY + 5,
                    head: [['No.', 'Nama Pasien', 'Alasan Rujukan', 'Fasilitas Kesehatan Tujuan', 'Waktu Rujukan', 'Keterangan']],
                    body: rujukanData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Add new page if needed
                if (doc.lastAutoTable.finalY > 240) {
                    doc.addPage();
                    currentY = 20;
                } else {
                    currentY = doc.lastAutoTable.finalY + 15;
                }

                // Evaluasi
                doc.text("EVALUASI KEGIATAN", 20, currentY);
                currentY += 10;

                doc.text("Kendala yang Dihadapi:", 20, currentY);
                currentY += 7;
                doc.text(document.getElementById('kendala').value || "-", 25, currentY);
                currentY += 15;

                doc.text("Solusi yang Dilakukan:", 20, currentY);
                currentY += 7;
                doc.text(document.getElementById('solusi').value || "-", 25, currentY);
                currentY += 15;

                doc.text("Rekomendasi untuk Kegiatan Selanjutnya:", 20, currentY);
                currentY += 7;
                doc.text(document.getElementById('rekomendasi').value || "-", 25, currentY);
                currentY += 20;

                // Tanda tangan
                doc.text("Petugas Medis", 40, currentY);
                doc.text("Koordinator Acara", 150, currentY);

                currentY += 20;
                doc.text("________________", 40, currentY);
                doc.text("________________", 150, currentY);

                // Save the PDF
                doc.save(`Dokumentasi_Tim_Medis_${tanggal}_${cabor}.pdf`);
                showToast('PDF berhasil diunduh', 'success');
            });

            // Update dashboard
            function updateDashboard() {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];

                // Update total dokumentasi
                document.querySelector('.dashboard-card:nth-child(1) .card-value').textContent = savedData.length;

                // Count today's cases from all kasus data
                const today = new Date().toISOString().split('T')[0];
                let todayCasesCount = 0;
                savedData.forEach(item => {
                    if (item.tanggal === today && Array.isArray(item.kasus_nama)) {
                        // Count non-empty kasus entries for today
                        todayCasesCount += item.kasus_nama.filter(nama => nama && nama.trim() !== '').length;
                    }
                });
                document.querySelector('.dashboard-card:nth-child(2) .card-value').textContent = todayCasesCount;

                // Count rujukan
                let rujukanCount = 0;
                savedData.forEach(item => {
                    if (item.rujukan_nama && Array.isArray(item.rujukan_nama)) {
                        rujukanCount += item.rujukan_nama.filter(name => name.trim() !== '').length;
                    }
                });
                document.querySelector('.dashboard-card:nth-child(3) .card-value').textContent = rujukanCount;

                // Count unique cabang olahraga
                const uniqueCabor = new Set(savedData.map(item => item.cabor));
                document.querySelector('.dashboard-card:nth-child(4) .card-value').textContent = uniqueCabor.size;

                // Update recent activities
                const recentActivities = document.getElementById('recent-activities');
                recentActivities.innerHTML = '';

                // Get recent activities
                const recentActs = JSON.parse(localStorage.getItem('recentActivities') || '[]');

                if (recentActs.length === 0) {
                    recentActivities.innerHTML = '<div class="history-item">Belum ada aktivitas terbaru</div>';
                } else {
                    recentActs.forEach(item => {
                        const activityDate = formatDateIndonesia(item.date);
                        const activityTime = formatTime(item.date);
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        const action = item.action === 'delete' ? 'text-danger' : '';
                        div.innerHTML = `<strong>${activityDate} ${activityTime}</strong> - ${item.petugas} ${item.actionText} kegiatan ${item.cabor} di ${item.lokasi}`;
                        recentActivities.appendChild(div);
                    });
                }
            }

            // Update history
            function updateHistory() {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                if (savedData.length === 0) {
                    historyList.innerHTML = '<div class="history-item">Belum ada riwayat dokumentasi</div>';
                } else {
                    savedData.reverse().forEach(item => {
                        const historyDate = formatDateIndonesia(item.date);
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        div.innerHTML = `
                            <h3>${item.cabor} - ${item.lokasi}</h3>
                            <p><strong>Tanggal:</strong> ${historyDate} | <strong>Petugas:</strong> ${item.petugas}</p>
                            <div class="history-actions">
                                <button class="view-btn" data-id="${item.id}"><i class="fas fa-eye"></i> Lihat Detail</button>
                                <button class="edit-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Edit</button>
                                <button class="download-btn" data-id="${item.id}"><i class="fas fa-download"></i> Unduh PDF</button>
                                <button class="delete-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Hapus</button>
                            </div>
                        `;
                        historyList.appendChild(div);
                    });

                    // Add event listeners to buttons
                    document.querySelectorAll('.view-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            const id = parseInt(this.getAttribute('data-id'));
                            viewItemDetail(id);
                        });
                    });

                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            const id = parseInt(this.getAttribute('data-id'));
                            editItem(id);
                        });
                    });

                    document.querySelectorAll('.download-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            const id = parseInt(this.getAttribute('data-id'));
                            const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                            const item = savedData.find(doc => doc.id === id);
                            if (item) {
                                generatePDFFromData(item);
                                showToast('PDF berhasil diunduh', 'success');
                            }
                        });
                    });

                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', function () {
                            const id = parseInt(this.getAttribute('data-id'));
                            confirmDeleteItem(id);
                        });
                    });
                }
            }

            // Function to view item detail in modal
            function viewItemDetail(id) {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                const item = savedData.find(doc => doc.id === id);

                if (item) {
                    const detailContent = document.getElementById('detailContent');

                    // Format date
                    const formattedDate = formatDateIndonesia(item.date);

                    let html = `
                        <div class="detail-header">
                            <h3>${item.cabor} - ${item.lokasi}</h3>
                            <p><strong>Tanggal&emsp; :</strong> ${formattedDate}</p>
                            <p><strong>Petugas&emsp;:</strong> ${item.petugas}</p>
                            <p><strong>Waktu&emsp;&emsp;:</strong> ${item.waktu}</p>
                        </div>
                    `;

                    // Kasus data
                    if (Array.isArray(item.kasus_nama) && item.kasus_nama.some(name => name && name.trim() !== '')) {
                        html += `<h4><i class="fas fa-user-injured"></i> Data Kasus</h4>`;
                        html += `<div class="table-container"><table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Waktu</th>
                                    <th>Nama Pasien</th>
                                    <th>Jenis Kelamin</th>
                                    <th>Keluhan</th>
                                    <th>Penanganan</th>
                                    <th>Hasil</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        for (let i = 0; i < item.kasus_nama.length; i++) {
                            if (item.kasus_nama[i] && item.kasus_nama[i].trim() !== '') {
                                html += `<tr>
                                    <td>${i + 1}</td>
                                    <td>${item.kasus_waktu ? item.kasus_waktu[i] || '-' : '-'}</td>
                                    <td>${item.kasus_nama[i] || '-'}</td>
                                    <td>${item.kasus_jk ? (item.kasus_jk[i] === 'L' ? 'Laki-laki' : 'Perempuan') : '-'}</td>
                                    <td>${item.kasus_keluhan ? item.kasus_keluhan[i] || '-' : '-'}</td>
                                    <td>${item.kasus_penanganan ? item.kasus_penanganan[i] || '-' : '-'}</td>
                                    <td>${item.kasus_hasil ? item.kasus_hasil[i] || '-' : '-'}</td>
                                </tr>`;
                            }
                        }

                        html += `</tbody></table></div>`;
                    } else {
                        html += `<h4><i class="fas fa-user-injured"></i> Data Kasus</h4>`;
                        html += `<p>Tidak ada data kasus.</p>`;
                    }

                    // Obat data
                    if (Array.isArray(item.obat_nama) && item.obat_nama.some(name => name && name.trim() !== '')) {
                        html += `<h4><i class="fas fa-pills"></i> Penggunaan Obat & Alat Medis</h4>`;
                        html += `<div class="table-container"><table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Item</th>
                                    <th>Jumlah Awal</th>
                                    <th>Jumlah Terpakai</th>
                                    <th>Sisa</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        for (let i = 0; i < item.obat_nama.length; i++) {
                            if (item.obat_nama[i] && item.obat_nama[i].trim() !== '') {
                                html += `<tr>
                                    <td>${i + 1}</td>
                                    <td>${item.obat_nama[i] || '-'}</td>
                                    <td>${item.obat_awal ? item.obat_awal[i] || '-' : '-'}</td>
                                    <td>${item.obat_terpakai ? item.obat_terpakai[i] || '-' : '-'}</td>
                                    <td>${item.obat_sisa ? item.obat_sisa[i] || '-' : '-'}</td>
                                    <td>${item.obat_keterangan ? item.obat_keterangan[i] || '-' : '-'}</td>
                                </tr>`;
                            }
                        }

                        html += `</tbody></table></div>`;
                    } else {
                        html += `<h4><i class="fas fa-pills"></i> Penggunaan Obat & Alat Medis</h4>`;
                        html += `<p>Tidak ada data penggunaan obat & alat medis.</p>`;
                    }

                    // Perlengkapan data
                    if (Array.isArray(item.perlengkapan_nama) && item.perlengkapan_nama.some(name => name && name.trim() !== '')) {
                        html += `<h4><i class="fas fa-toolbox"></i> Catatan Perlengkapan dan Alat Medis</h4>`;
                        html += `<div class="table-container"><table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Perlengkapan</th>
                                    <th>Kondisi Awal</th>
                                    <th>Kondisi Akhir</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        for (let i = 0; i < item.perlengkapan_nama.length; i++) {
                            if (item.perlengkapan_nama[i] && item.perlengkapan_nama[i].trim() !== '') {
                                html += `<tr>
                                    <td>${i + 1}</td>
                                    <td>${item.perlengkapan_nama[i] || '-'}</td>
                                    <td>${item.perlengkapan_awal ? item.perlengkapan_awal[i] || '-' : '-'}</td>
                                    <td>${item.perlengkapan_akhir ? item.perlengkapan_akhir[i] || '-' : '-'}</td>
                                    <td>${item.perlengkapan_keterangan ? item.perlengkapan_keterangan[i] || '-' : '-'}</td>
                                </tr>`;
                            }
                        }

                        html += `</tbody></table></div>`;
                    } else {
                        html += `<h4><i class="fas fa-toolbox"></i> Catatan Perlengkapan dan Alat Medis</h4>`;
                        html += `<p>Tidak ada data perlengkapan.</p>`;
                    }

                    // Rujukan data
                    if (Array.isArray(item.rujukan_nama) && item.rujukan_nama.some(name => name && name.trim() !== '')) {
                        html += `<h4><i class="fas fa-ambulance"></i> Rujukan Medis</h4>`;
                        html += `<div class="table-container"><table>
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Nama Pasien</th>
                                    <th>Alasan Rujukan</th>
                                    <th>Fasilitas Kesehatan</th>
                                    <th>Waktu</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>
                            <tbody>`;

                        for (let i = 0; i < item.rujukan_nama.length; i++) {
                            if (item.rujukan_nama[i] && item.rujukan_nama[i].trim() !== '') {
                                html += `<tr>
                                    <td>${i + 1}</td>
                                    <td>${item.rujukan_nama[i] || '-'}</td>
                                    <td>${item.rujukan_alasan ? item.rujukan_alasan[i] || '-' : '-'}</td>
                                    <td>${item.rujukan_tujuan ? item.rujukan_tujuan[i] || '-' : '-'}</td>
                                    <td>${item.rujukan_waktu ? item.rujukan_waktu[i] || '-' : '-'}</td>
                                    <td>${item.rujukan_keterangan ? item.rujukan_keterangan[i] || '-' : '-'}</td>
                                </tr>`;
                            }
                        }

                        html += `</tbody></table></div>`;
                    } else {
                        html += `<h4><i class="fas fa-ambulance"></i> Rujukan Medis</h4>`;
                        html += `<p>Tidak ada data rujukan.</p>`;
                    }

                    // Evaluasi
                    html += `<h4><i class="fas fa-clipboard-check"></i> Evaluasi Kegiatan</h4>`;
                    html += `
                        <div class="detail-evaluasi">
                            <h5>Kendala yang Dihadapi:</h5>
                            <p>${item.kendala || '-'}</p>
                            
                            <h5>Solusi yang Dilakukan:</h5>
                            <p>${item.solusi || '-'}</p>
                            
                            <h5>Rekomendasi untuk Kegiatan Selanjutnya:</h5>
                            <p>${item.rekomendasi || '-'}</p>
                        </div>
                    `;

                    detailContent.innerHTML = html;
                    openModal('detailModal');
                } else {
                    showToast('Data tidak ditemukan', 'error');
                }
            }

            // Function to confirm delete item
            function confirmDeleteItem(id) {
                const savedData = JSON.parse(localStorage.getItem('medicalDocuments')) || [];
                const item = savedData.find(doc => doc.id === id);

                if (item) {
                    document.getElementById('confirmMessage').textContent = `Apakah Anda yakin ingin menghapus dokumentasi "${item.cabor} - ${item.lokasi}"?`;

                    // Set up confirm modal buttons
                    document.getElementById('confirmAction').onclick = function () {
                        // Add to recent activities before deleting
                        item.action = 'delete';
                        item.actionText = 'menghapus';
                        item.date = new Date().toISOString(); // Update timestamp
                        
                        // Get recent activities
                        let recentActs = JSON.parse(localStorage.getItem('recentActivities') || '[]');
                        recentActs.unshift(item);
                        recentActs = recentActs.slice(0, 5); // Keep only last 5
                        localStorage.setItem('recentActivities', JSON.stringify(recentActs));

                        const updatedData = savedData.filter(doc => doc.id !== id);
                        localStorage.setItem('medicalDocuments', JSON.stringify(updatedData));

                        closeModal(document.getElementById('confirmModal'));
                        showToast('Dokumentasi berhasil dihapus', 'success');

                        updateDashboard();
                        updateHistory();
                    };

                    document.getElementById('cancelAction').onclick = function () {
                        closeModal(document.getElementById('confirmModal'));
                    };

                    openModal('confirmModal');
                } else {
                    showToast('Data tidak ditemukan', 'error');
                }
            }

            // Generate PDF from stored data
            function generatePDFFromData(data) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Set font to Times New Roman
                doc.setFont("times", "normal");
                doc.setFontSize(12);

                // Add header
                doc.setFontSize(16);
                doc.text("DOKUMENTASI & ADMINISTRASI TIM MEDIC", 105, 20, { align: 'center' });
                doc.setFontSize(12);

                // Add form data
                const spacing = 56; // Reduced from 150 to 100 for tighter layout
                const colonPos = 54; // Position for colons

                // Helper function to draw aligned text
                function drawFormField(label, value, yPos) {
                    doc.text(label, 20, yPos);
                    doc.text(":", colonPos, yPos);
                    doc.text(value, spacing, yPos);
                }

                // Draw form fields with aligned colons
                drawFormField("Nama Petugas", data.petugas, 40);
                drawFormField("Tanggal", data.tanggal, 48);
                drawFormField("Lokasi Kegiatan", data.lokasi, 56);
                drawFormField("Cabang Olahraga", data.cabor, 64);
                drawFormField("Waktu", data.waktu, 72);

                // Data Kasus table
                doc.text("DATA KASUS", 20, 85);

                const kasusData = [];
                if (Array.isArray(data.kasus_nama)) {
                    for (let i = 0; i < data.kasus_nama.length; i++) {
                        if (data.kasus_nama[i] && data.kasus_nama[i].trim() !== '') {
                            kasusData.push([
                                i + 1,
                                data.kasus_waktu ? data.kasus_waktu[i] || '' : '',
                                data.kasus_nama[i] || '',
                                data.kasus_jk ? data.kasus_jk[i] || '' : '',
                                data.kasus_keluhan ? data.kasus_keluhan[i] || '' : '',
                                data.kasus_penanganan ? data.kasus_penanganan[i] || '' : '',
                                data.kasus_hasil ? data.kasus_hasil[i] || '' : ''
                            ]);
                        }
                    }
                }

                if (kasusData.length === 0) {
                    kasusData.push(['', '', '', '', '', '', '']);
                }

                doc.autoTable({
                    startY: 90,
                    head: [['No.', 'Waktu', 'Nama Pasien', 'Jenis Kelamin', 'Keluhan/Cedera', 'Penanganan', 'Hasil']],
                    body: kasusData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Continue with other tables and sections...
                let currentY = doc.lastAutoTable.finalY + 10;
                doc.text("PENGGUNAAN OBAT & ALAT MEDIS", 20, currentY);

                const obatData = [];
                if (Array.isArray(data.obat_nama)) {
                    for (let i = 0; i < data.obat_nama.length; i++) {
                        if (data.obat_nama[i] && data.obat_nama[i].trim() !== '') {
                            obatData.push([
                                i + 1,
                                data.obat_nama[i] || '',
                                data.obat_awal ? data.obat_awal[i] || '' : '',
                                data.obat_terpakai ? data.obat_terpakai[i] || '' : '',
                                data.obat_sisa ? data.obat_sisa[i] || '' : '',
                                data.obat_keterangan ? data.obat_keterangan[i] || '' : ''
                            ]);
                        }
                    }
                }

                if (obatData.length === 0) {
                    obatData.push(['', '', '', '', '', '']);
                }

                doc.autoTable({
                    startY: currentY + 5,
                    head: [['No.', 'Nama Item', 'Jumlah Awal', 'Jumlah Terpakai', 'Sisa', 'Keterangan']],
                    body: obatData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Perlengkapan table
                currentY = doc.lastAutoTable.finalY + 10;
                doc.text("CATATAN PERLENGKAPAN DAN ALAT MEDIS", 20, currentY);

                const perlengkapanData = [];
                if (Array.isArray(data.perlengkapan_nama)) {
                    for (let i = 0; i < data.perlengkapan_nama.length; i++) {
                        if (data.perlengkapan_nama[i] && data.perlengkapan_nama[i].trim() !== '') {
                            perlengkapanData.push([
                                i + 1,
                                data.perlengkapan_nama[i] || '',
                                data.perlengkapan_awal ? data.perlengkapan_awal[i] || '' : '',
                                data.perlengkapan_akhir ? data.perlengkapan_akhir[i] || '' : '',
                                data.perlengkapan_keterangan ? data.perlengkapan_keterangan[i] || '' : ''
                            ]);
                        }
                    }
                }

                if (perlengkapanData.length === 0) {
                    perlengkapanData.push(['', '', '', '', '']);
                }

                doc.autoTable({
                    startY: currentY + 5,
                    head: [['No.', 'Nama Perlengkapan', 'Kondisi Awal', 'Kondisi Akhir', 'Keterangan']],
                    body: perlengkapanData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Rujukan Medis table
                currentY = doc.lastAutoTable.finalY + 10;
                doc.text("RUJUKAN MEDIS", 20, currentY);

                const rujukanData = [];
                if (Array.isArray(data.rujukan_nama)) {
                    for (let i = 0; i < data.rujukan_nama.length; i++) {
                        if (data.rujukan_nama[i] && data.rujukan_nama[i].trim() !== '') {
                            rujukanData.push([
                                i + 1,
                                data.rujukan_nama[i] || '',
                                data.rujukan_alasan ? data.rujukan_alasan[i] || '' : '',
                                data.rujukan_tujuan ? data.rujukan_tujuan[i] || '' : '',
                                data.rujukan_waktu ? data.rujukan_waktu[i] || '' : '',
                                data.rujukan_keterangan ? data.rujukan_keterangan[i] || '' : ''
                            ]);
                        }
                    }
                }

                if (rujukanData.length === 0) {
                    rujukanData.push(['', '', '', '', '', '']);
                }

                doc.autoTable({
                    startY: currentY + 5,
                    head: [['No.', 'Nama Pasien', 'Alasan Rujukan', 'Fasilitas Kesehatan Tujuan', 'Waktu Rujukan', 'Keterangan']],
                    body: rujukanData,
                    theme: 'grid',
                    styles: {
                        font: 'times',
                        fontSize: 10
                    }
                });

                // Add new page if needed
                if (doc.lastAutoTable.finalY > 240) {
                    doc.addPage();
                    currentY = 20;
                } else {
                    currentY = doc.lastAutoTable.finalY + 15;
                }

                // Evaluasi
                doc.text("EVALUASI KEGIATAN", 20, currentY);
                currentY += 10;

                doc.text("Kendala yang Dihadapi:", 20, currentY);
                currentY += 7;
                doc.text(data.kendala || "-", 25, currentY);
                currentY += 15;

                doc.text("Solusi yang Dilakukan:", 20, currentY);
                currentY += 7;
                doc.text(data.solusi || "-", 25, currentY);
                currentY += 15;

                doc.text("Rekomendasi untuk Kegiatan Selanjutnya:", 20, currentY);
                currentY += 7;
                doc.text(data.rekomendasi || "-", 25, currentY);
                currentY += 20;

                // Tanda tangan
                doc.text("Petugas Medis", 40, currentY);
                doc.text("Koordinator Acara", 150, currentY);

                currentY += 20;
                doc.text("________________", 40, currentY);
                doc.text("________________", 150, currentY);

                // Save the PDF
                doc.save(`Dokumentasi_Tim_Medis_${data.tanggal}_${data.cabor}.pdf`);
            }

            // Initialize dashboard and history
            updateDashboard();
            updateHistory();
        });
    </script>
</body>

</html>
